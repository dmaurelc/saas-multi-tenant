// Prisma Schema for SaaS Multi-Tenant
// Database: Neon (PostgreSQL serverless)

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// TENANT - Multi-tenant core
// ============================================

model Tenant {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  logo      String?
  primaryColor   String? @map("primary_color")
  secondaryColor String? @map("secondary_color")
  customDomain   String? @unique @map("custom_domain")
  plan      Plan     @default(FREE)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  users        User[]
  auditLogs    AuditLog[]
  invitations  Invitation[]

  @@index([slug])
  @@index([customDomain])
  @@map("tenants")
}

// ============================================
// USER - Users within tenants
// ============================================

model User {
  id           String   @id @default(uuid())
  tenantId     String   @map("tenant_id")
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  email        String   @unique
  passwordHash String?  @map("password_hash")
  name         String?
  avatar       String?
  role         Role     @default(STAFF)
  permissions  Json?    // Permisos adicionales espec√≠ficos del usuario
  isActive     Boolean  @default(true) @map("is_active")
  emailVerified DateTime? @map("email_verified")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  auditLogs    AuditLog[]
  sessions     Session[]
  magicLinks   MagicLink[]
  oauthAccounts OAuthAccount[]
  invitationsSent Invitation[] @relation("Inviter")
  invitationsAccepted Invitation[] @relation("Accepter")

  @@index([tenantId])
  @@index([email])
  @@map("users")
}

// ============================================
// SESSION - User sessions
// ============================================

model Session {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token        String   @unique
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([token])
  @@index([userId])
  @@map("sessions")
}

// ============================================
// MAGIC LINK - Passwordless authentication
// ============================================

model MagicLink {
  id        String   @id @default(uuid())
  email     String
  token     String   @unique
  tenantId  String?  @map("tenant_id") // Optional: for existing tenant login
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime @default(now()) @map("created_at")
  userId    String?  @map("user_id")
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([email])
  @@index([expiresAt])
  @@map("magic_links")
}

// ============================================
// OAUTH ACCOUNT - Social authentication
// ============================================

model OAuthAccount {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider      OAuthProvider
  providerAccountId String @map("provider_account_id")
  accessToken   String?  @map("access_token")
  refreshToken  String?  @map("refresh_token")
  expiresAt     DateTime? @map("expires_at")
  tokenType     String?  @map("token_type")
  scope         String?
  idToken       String?  @map("id_token")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@index([provider])
  @@map("oauth_accounts")
}

// ============================================
// INVITATION - User invitations
// ============================================

model Invitation {
  id           String        @id @default(uuid())
  tenantId     String        @map("tenant_id")
  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  email        String
  role         Role          @default(STAFF)
  token        String        @unique
  expiresAt    DateTime      @map("expires_at")
  acceptedAt   DateTime?     @map("accepted_at")
  invitedBy    String        @map("invited_by")
  invitedByUser User         @relation("Inviter", fields: [invitedBy], references: [id], onDelete: Cascade)
  acceptedBy   String?       @map("accepted_by")
  acceptedUser User?         @relation("Accepter", fields: [acceptedBy], references: [id], onDelete: SetNull)
  createdAt    DateTime      @default(now()) @map("created_at")

  @@index([tenantId])
  @@index([email])
  @@index([token])
  @@index([expiresAt])
  @@map("invitations")
}

// ============================================
// AUDIT LOG - Audit trail
// ============================================

model AuditLog {
  id        String   @id @default(uuid())
  tenantId  String   @map("tenant_id")
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userId    String?  @map("user_id")
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  action    String
  entity    String
  entityId  String?  @map("entity_id")
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")

  @@index([tenantId])
  @@index([userId])
  @@index([entity, entityId])
  @@map("audit_logs")
}

// ============================================
// ENUMS
// ============================================

enum Plan {
  FREE
  PRO
  BUSINESS
  ENTERPRISE
}

enum Role {
  OWNER     // Full access, can manage subscription
  ADMIN     // Full access except subscription
  STAFF     // Limited access based on permissions
  CUSTOMER  // End customer (for certain verticals)
}

enum OAuthProvider {
  GOOGLE
  GITHUB
}
