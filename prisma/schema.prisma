// Prisma Schema for SaaS Multi-Tenant
// Database: Neon (PostgreSQL serverless)

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// TENANT - Multi-tenant core
// ============================================

model Tenant {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  logo      String?
  primaryColor   String? @map("primary_color")
  secondaryColor String? @map("secondary_color")
  customDomain   String? @unique @map("custom_domain")
  plan      Plan     @default(FREE)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  users        User[]
  auditLogs    AuditLog[]
  invitations  Invitation[]
  subscriptions Subscription[]
  notifications Notification[]
  notificationPreferences NotificationPreference[]
  events       Event[]
  invoices     Invoice[]
  paymentMethods PaymentMethod[]
  payments     Payment[]

  @@index([slug])
  @@index([customDomain])
  @@map("tenants")
}

// ============================================
// USER - Users within tenants
// ============================================

model User {
  id           String   @id @default(uuid())
  tenantId     String   @map("tenant_id")
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  email        String   @unique
  passwordHash String?  @map("password_hash")
  name         String?
  avatar       String?
  role         Role     @default(STAFF)
  permissions  Json?    // Permisos adicionales espec√≠ficos del usuario
  isActive     Boolean  @default(true) @map("is_active")
  emailVerified DateTime? @map("email_verified")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  auditLogs    AuditLog[]
  sessions     Session[]
  magicLinks   MagicLink[]
  oauthAccounts OAuthAccount[]
  invitationsSent Invitation[] @relation("Inviter")
  invitationsAccepted Invitation[] @relation("Accepter")
  notifications Notification[]
  notificationPreference NotificationPreference?
  events       Event[]

  @@index([tenantId])
  @@index([email])
  @@map("users")
}

// ============================================
// SESSION - User sessions
// ============================================

model Session {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token        String   @unique
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([token])
  @@index([userId])
  @@map("sessions")
}

// ============================================
// MAGIC LINK - Passwordless authentication
// ============================================

model MagicLink {
  id        String   @id @default(uuid())
  email     String
  token     String   @unique
  tenantId  String?  @map("tenant_id") // Optional: for existing tenant login
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime @default(now()) @map("created_at")
  userId    String?  @map("user_id")
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([email])
  @@index([expiresAt])
  @@map("magic_links")
}

// ============================================
// OAUTH ACCOUNT - Social authentication
// ============================================

model OAuthAccount {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider      OAuthProvider
  providerAccountId String @map("provider_account_id")
  accessToken   String?  @map("access_token")
  refreshToken  String?  @map("refresh_token")
  expiresAt     DateTime? @map("expires_at")
  tokenType     String?  @map("token_type")
  scope         String?
  idToken       String?  @map("id_token")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@index([provider])
  @@map("oauth_accounts")
}

// ============================================
// INVITATION - User invitations
// ============================================

model Invitation {
  id           String        @id @default(uuid())
  tenantId     String        @map("tenant_id")
  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  email        String
  role         Role          @default(STAFF)
  token        String        @unique
  expiresAt    DateTime      @map("expires_at")
  acceptedAt   DateTime?     @map("accepted_at")
  invitedBy    String        @map("invited_by")
  invitedByUser User         @relation("Inviter", fields: [invitedBy], references: [id], onDelete: Cascade)
  acceptedBy   String?       @map("accepted_by")
  acceptedUser User?         @relation("Accepter", fields: [acceptedBy], references: [id], onDelete: SetNull)
  createdAt    DateTime      @default(now()) @map("created_at")

  @@index([tenantId])
  @@index([email])
  @@index([token])
  @@index([expiresAt])
  @@map("invitations")
}

// ============================================
// AUDIT LOG - Audit trail
// ============================================

model AuditLog {
  id        String   @id @default(uuid())
  tenantId  String   @map("tenant_id")
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userId    String?  @map("user_id")
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  action    String
  entity    String
  entityId  String?  @map("entity_id")
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")

  @@index([tenantId])
  @@index([userId])
  @@index([entity, entityId])
  @@map("audit_logs")
}

// ============================================
// SUBSCRIPTIONS - Subscription management
// ============================================

model Subscription {
  id                       String   @id @default(uuid())
  tenantId                 String   @unique @map("tenant_id")
  tenant                   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  provider                 Provider @default(STRIPE)
  providerSubscriptionId   String?  @map("provider_subscription_id")
  providerCustomerId       String?  @map("provider_customer_id")

  planId                   Plan     @default(FREE) @map("plan_id")
  status                   SubscriptionStatus @default(ACTIVE)
  currentPeriodStart       DateTime? @map("current_period_start")
  currentPeriodEnd         DateTime? @map("current_period_end")
  cancelAtPeriodEnd        Boolean  @default(false) @map("cancel_at_period_end")
  canceledAt               DateTime? @map("canceled_at")

  metadata                 Json?

  invoices                 Invoice[]
  paymentMethods           PaymentMethod[]

  createdAt                DateTime @default(now()) @map("created_at")
  updatedAt                DateTime @updatedAt @map("updated_at")

  @@index([providerSubscriptionId])
  @@map("subscriptions")
}

// ============================================
// INVOICES - Billing records
// ============================================

model Invoice {
  id                  String   @id @default(uuid())
  tenantId            String   @map("tenant_id")
  tenant              Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  subscriptionId      String?  @map("subscription_id")
  subscription        Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)

  provider            Provider @default(STRIPE)
  providerInvoiceId   String?  @map("provider_invoice_id")

  status              InvoiceStatus @default(DRAFT)
  currency            String   @default("CLP")
  subtotal            Int
  tax                 Int      @default(0)
  total               Int

  dueDate             DateTime? @map("due_date")
  paidAt              DateTime? @map("paid_at")

  invoiceUrl          String?  @map("invoice_url")
  lineItems           Json?
  metadata            Json?

  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  payments            Payment[]

  @@index([subscriptionId])
  @@index([providerInvoiceId])
  @@map("invoices")
}

// ============================================
// PAYMENT METHODS - Stored payment methods
// ============================================

model PaymentMethod {
  id                String   @id @default(uuid())
  tenantId          String   @map("tenant_id")
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  subscriptionId    String?  @map("subscription_id")
  subscription      Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)

  provider          Provider @default(STRIPE)
  providerMethodId  String   @map("provider_method_id")

  type              PaymentType
  isDefault         Boolean  @default(false) @map("is_default")

  last4             String?
  brand             String?
  expiresAt         DateTime? @map("expires_at")

  metadata          Json?

  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@index([subscriptionId])
  @@map("payment_methods")
}

// ============================================
// PAYMENTS - Individual payment records
// ============================================

model Payment {
  id                  String   @id @default(uuid())
  tenantId            String   @map("tenant_id")
  tenant              Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  invoiceId           String?  @map("invoice_id")
  invoice             Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  provider            Provider @default(STRIPE)
  providerPaymentId   String?  @map("provider_payment_id")

  status              PaymentStatus @default(PENDING)
  amount              Int
  currency            String   @default("CLP")

  processedAt         DateTime? @map("processed_at")
  metadata            Json?

  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  @@index([invoiceId])
  @@index([providerPaymentId])
  @@map("payments")
}

// ============================================
// NOTIFICATIONS - User notifications
// ============================================

model Notification {
  id              String   @id @default(uuid())
  tenantId        String   @map("tenant_id")
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  userId          String   @map("user_id")
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  type            NotificationType
  title           String
  message         String   @db.Text
  data            Json?

  readAt          DateTime? @map("read_at")
  actionUrl       String?  @map("action_url")
  actionLabel     String?  @map("action_label")

  createdAt       DateTime @default(now()) @map("created_at")
  expiresAt       DateTime? @map("expires_at")

  @@index([tenantId])
  @@index([userId])
  @@index([userId, readAt])
  @@map("notifications")
}

// ============================================
// NOTIFICATION PREFERENCES - User notification settings
// ============================================

model NotificationPreference {
  id              String   @id @default(uuid())
  tenantId        String   @map("tenant_id")
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  userId          String   @unique @map("user_id")
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  emailEnabled    Boolean  @default(true) @map("email_enabled")
  inAppEnabled    Boolean  @default(true) @map("in_app_enabled")
  preferences     Json?

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@map("notification_preferences")
}

// ============================================
// EVENTS - Analytics events
// ============================================

model Event {
  id            String   @id @default(uuid())
  tenantId      String   @map("tenant_id")
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  userId        String?  @map("user_id")
  user          User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  eventType     String   @map("event_type")
  eventName     String   @map("event_name")
  properties    Json?

  sessionId     String?  @map("session_id")
  ipAddress     String?  @map("ip_address")
  userAgent     String?  @map("user_agent")
  referrer      String?

  createdAt     DateTime @default(now()) @map("created_at")

  @@index([tenantId])
  @@index([userId])
  @@index([eventType])
  @@index([createdAt])
  @@map("events")
}

// ============================================
// ENUMS
// ============================================

enum Plan {
  FREE
  PRO
  BUSINESS
  ENTERPRISE
}

enum Role {
  OWNER     // Full access, can manage subscription
  ADMIN     // Full access except subscription
  STAFF     // Limited access based on permissions
  CUSTOMER  // End customer (for certain verticals)
}

enum OAuthProvider {
  GOOGLE
  GITHUB
}

enum Provider {
  STRIPE
  TRANSBANK
  MERCADOPAGO
  FLOW
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
  INCOMPLETE
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
  UNCOLLECTIBLE
}

enum PaymentType {
  CARD
  BANK_ACCOUNT
  ONECLICK
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum NotificationType {
  USER_INVITED
  USER_ADDED
  USER_ROLE_CHANGED
  PAYMENT_SUCCEEDED
  PAYMENT_FAILED
  SUBSCRIPTION_CREATED
  SUBSCRIPTION_UPDATED
  SUBSCRIPTION_CANCELED
  INVOICE_AVAILABLE
  TENANT_UPDATED
  SYSTEM_ANNOUNCEMENT
  CUSTOM
}
